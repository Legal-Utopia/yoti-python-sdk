# Django Yoti #

Instructions for configuring your Django project to integrate with Yoti.

## Plugin configuration ##
### General settings ###

* First you need to add `django_yoti` plugin to your INSTALLED_APPS setting like this:
```python
# your_django_project/settings.py

...

INSTALLED_APPS = [
    ...
    'django_yoti',
]
```

* Django Yoti plugin provides the following template context var:
    - `yoti_application_id`

* If you're using a Django template backend that supports context processors
like default DTL (Django Template Language) and want to use context tags
inside your template (e.g. `{{yoti_application_id}}`), then you should
include `django_yoti`'s context processors into your templates
configuration like this:
```python
# your_django_project/settings.py

...

TEMPLATES = [
    {
        ...
        'OPTIONS': {
            'context_processors': [
                ...
                'django_yoti.context_processors.yoti_context',
            ],
        },
    },
]
```
* Otherwise you'll have to pass Yoti context to your templates manually:
```python
from django_yoti import yoti_context

def some_view(request):
    return render(request, 'index.html', yoti_context)
```

The following variables are then required for the plugin to work, these are found under the different tabs of your Yoti application's settings page ([Yoti Dashboard](https://www.yoti.com/dashboard/)):

* **`YOTI_APPLICATION_ID`** - This is used to configure the [Yoti Login Button](https://www.yoti.com/developers/documentation/#2-front-end-integration).
* **`YOTI_CLIENT_SDK_ID`** - is the SDK identifier generated by Yoti Dashboard in the Key tab when you create your app. Note this is not your Application Identifier which is needed by your client-side code
* **`YOTI_KEY_FILE_PATH`** - is the path to the application .pem file, we recommend keeping your .pem file outside of your repository. It can be downloaded only once from the Keys tab in your Yoti Dashboard. (e.g. /home/user/.ssh/access-security.pem)

**Please do not open the pem file** as this might corrupt the key and you will need to create a new application.

One way to configure these environment variables is to use an .env file. There are `.env.example` files supplied in the [Django](/examples/yoti_example_django/yoti_example/.env.example) and [Flask](/examples/yoti_example_flask/.env.example) example projects, which you can rename to `.env` and enter your settings into this file.

Alternatively you could define these settings in the `settings.py` file like this:
```python
# your_django_project/settings.py

...

YOTI = {
    'YOTI_APPLICATION_ID': '...',
    'YOTI_CLIENT_SDK_ID': '...',
    'YOTI_KEY_FILE_PATH': '...',
    ...
}
```

### Endpoints configuration ###

`django_yoti` plugin provides some default endpoints:
```python
# django_yoti/urls.py

urlpatterns = [
    url(r'^auth/', views.auth, name='yoti_auth'),
    url(r'^login/', views.login, name='yoti_login'),
    url(r'^profile/', views.profile, name='yoti_profile')
]
```
`yoti_auth` URL is used for receiving token via callback and shouldn't be changed.<br>
The last two URLs are examples and can be overridden by the following settings:

```python
# your_django_project/settings.py

...

YOTI = {
    ...
    'YOTI_LOGIN_VIEW': '...',
    'YOTI_REDIRECT_TO': '...',
}
```
* **`YOTI_LOGIN_VIEW`**<br>
If *not* authenticated user is trying to access a view with
`@yoti_authenticated` decorator, he/she will be redirected to this view.<br>
Example: `login`<br>
In this case you should have something like this in your project's `urls.py` file:
```python
urlpatterns = [
    ...
    url(r'^login/', views.login, name='login'),
    ...
]
```
Default value: `yoti_login` (with `/yoti/login/` URL)

* **`YOTI_REDIRECT_TO`**<br>
View name to which user is redirected after successful authentication.<br>
Example: `profile`<br>
In this case you should have something like this in your project's `urls.py` file:
```python
urlpatterns = [
    ...
    url(r'^profile/', views.profile, name='profile'),
    ...
]
```
Default value: `yoti_profile`  (with `/yoti/profile/` URL

<br>

In order to use `django_yoti` plugin in your project, you should include
the plugin's endpoints in your project's `urls.py` file:
```python
# your_django_project/urls.py

 ...

urlpatterns = [
    ...
    url(r'^yoti/', include('django_yoti.urls')),
    ...
]
```

### Yoti application configuration ###

Your Yoti application's callback URL should point to `your_site.com/yoti/auth`.

## Using plugin ##

1. First you need to add a login button to some of your view's templates.
- You can do it by using the predefined login button:
```HTML
<span data-yoti-application-id="{{app_id}}">
    Log in with Yoti
</span>
```

By clicking this button, user will be redirected to the Yoti Authentication page.

*Remember to add an appropriate script to your page with login
button in order for it to work. See: [Yoti Developers Documentation](https://www.yoti.com/developers/#login-button-setup)*

2. After successful authentication, user will be redirected to a view,
provided by the `YOTI_REDIRECT_TO` setting.
3. In order to have an access to an authenticated user's information inside a view,
you should use a `@yoti_authenticated` decorator.
Example:
```python
from django_yoti import yoti_authenticated

@yoti_authenticated
def profile_view(request):
    user_id = request.yoti_user_id
    user_profile = request.yoti_user_profile
    return render(request, 'profile.html', user_profile)
```
<br>

To make `yoti_authenticated` decorator work with Django class based
views as well as with classic method based views, you can use it while
declaring your project's URLs:
```python
# your_django_project/urls.py
from django_yoti import yoti_authenticated

urlpatterns = [
    ...
    url(r'^profile/', yoti_authenticated(views.profile_view), name='yoti_profile'),
    # or
    url(r'^profile/', yoti_authenticated(views.ProfileView.as_view()), name='yoti_profile'),
    ...
]
```

4. All *not authenticated* users trying to access endpoint with this decorator,
will be redirected to an endpoint, provided by the `YOTI_LOGIN_VIEW` setting.

## Tests ##

To run unit tests (after running `python setup.py develop`), type: `python django_yoti/runtests.py`
